---
title: "9/24/2018"
output: html_notebook
---
#Notes
1.Treat missing values as a different category "2" 
2.Correlations among variables are imposed in interaction terms
3.Do LASSO on every bootstraping samples and extract coefficients
3.Do EDA on coefficients.

#set up
```{r setup}
knitr::opts_knit$set(root.dir = "C:/Users/yingj/OneDrive/Documents/data-cleaned")
```

#clean data
```{r}
#load all substances
##0
opd <- read.csv("opioid.csv")
##1
amp <- read.csv("amphetamines.csv")
##2
ben <- read.csv("Benzodiazapines.csv")
##3
can <- read.csv("Cannabinoids.csv")
##4
coc <- read.csv("Cocaine metabolites.csv")
##5
mtd <- read.csv("Methadone.csv")
##6
mtp <- read.csv("Methamphetamine.csv")
##7
oxy <- read.csv("Oxycodone.csv")
##8
pph <- read.csv("Propoxyphene.csv")

#first four weeks for all 9 substances
first4wk <- data.frame(opd$BASELINE, opd$WK1, opd$WK2, opd$WK3, opd$WK4,
                       amp$BASELINE, amp$WK1, amp$WK2, amp$WK3, amp$WK4,
                       ben$BASELINE, ben$WK1, ben$WK2, ben$WK3, ben$WK4,
                       can$BASELINE, can$WK1, can$WK2, can$WK3, can$WK4,
                       coc$BASELINE, coc$WK1, coc$WK2, coc$WK3, coc$WK4,
                       mtd$BASELINE, mtd$WK1, mtd$WK2, mtd$WK3, mtd$WK4,
                       mtp$BASELINE, mtp$WK1, mtp$WK2, mtp$WK3, mtp$WK4,
                       oxy$BASELINE, oxy$WK1, oxy$WK2, oxy$WK3, oxy$WK4,
                       pph$BASELINE, pph$WK1, pph$WK2, pph$WK3, pph$WK4)

#treatement
t <- opd$treatment

#outcome
outcome <- opd[,c("WK21", "WK22", "WK23", "WK24")]
outcome$pat <- apply(outcome, 1, paste, collapse = "")
y <- ifelse(outcome$pat=="0000", 0, 1)
y <- as.factor(y)

#all variables
first4wk$t <- t
```
#PCA on raw variables
```{r}
#add little noise
n <- nrow(first4wk)
p <- ncol(first4wk)

r <- matrix(rnorm(n*p, 0, 0.001), nrow = n, ncol = p)

first4wk[is.na(first4wk)] <- 2
first4wk[first4wk==-5] <- 2

all.x <- first4wk + r

#PCA
pca_x <- prcomp(first4wk)
plot(pca_x$x[, 1:2], col = y, pch = ".")
plot(pca_x$x[, 2:3], col = y, pch = ".")
```
#clustering
```{r}
cluster_2 <- kmeans(first4wk, 2)
chat <- cluster_2$cluster
yhat <- factor(chat, levels = unique(chat), labels = levels(y))
par(mfrow=c(1,2))
plot(pca_x$x[, 1:2], col = y, pch = ".", main = "True Outcome")
legend("topleft", c("negative", "positive"), col = c(1,2), lty = 1)
plot(pca_x$x[, 1:2], col = yhat, pch = ".", main = "Clustering Outcome")
legend("topleft", c("cluster1", "cluster2"), col = c(1,2), lty = 1)
```
#get a differential rate
```{r}
#cluster 1
mean(y[yhat=="1"]!=yhat[yhat=="1"])
#cluster 2
mean(y[yhat=="0"]!=yhat[yhat=="0"])
#
sum(which(y=="1")==which(yhat=="0"))
```
#Build a model on the second cluster
```{r}
#get data
c2.ind <- which(yhat=="0")
new.x <- first4wk[c2.ind,]
new.y <- y[c2.ind]
```
#split data
```{r}
ind <- sample.int(nrow(new.x), size = 0.7*nrow(new.x))
train.x <- new.x[ind, ]
train.y <- new.y[ind]
test.x <- new.x[-ind, ]
test.y <- new.y[-ind]
```
#formula
```{r}
f <- formula(train.y~.^2)
```
#design matrix
```{r}
dftrain <- cbind(train.x, train.y)
```
#packages
```{r}
library(glmnet)
library(boot)
library(ggplot2)
```
#Function for extracting LASSO coefficients 
```{r}
lasso_c <- function(x,i){
  df <- x[i, ]
  dmat <- model.matrix(train.y~.^2, data = df)
  dy <- df$train.y
  lassofit = cv.glmnet(dmat, dy, 
                       family = "binomial",
                       type.measure = "class",
                       nfolds = 5,
                       alpha = 1)
  boot.coef = as.matrix(predict(lassofit, s = lassofit$lambda.min, 
                        type = "coeff"))
  return(boot.coef)
}
```
#Bootstrap Lasso(no de-correlation)
```{r}
btlasso <- boot(data = dftrain, statistic = lasso_c, R = 100)
coefs <- btlasso$t
```
#PCA
```{r, warning=FALSE}
coef_pca <- prcomp(coefs[, -1])
plot(coef_pca$x)
```




